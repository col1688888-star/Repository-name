<script>
    (function() {
        const statusMsg = document.getElementById('statusMessage');
        function showMessage(msg, type = 'info') {
            statusMsg.innerText = msg;
            statusMsg.style.borderColor = type === 'error' ? '#c6574a' : (type === 'success' ? '#3fa38c' : '#3487a7');
            statusMsg.classList.add('show');
            setTimeout(() => statusMsg.classList.remove('show'), 2500);
        }

        // åˆå§‹åŒ–æ»¾è¼ªç¬¦è™Ÿ
        const symbols = ['7','ğŸ’','â­','ğŸ‹','ğŸ””','7','ğŸ’'];
        ['reelContentL','reelContentC','reelContentR'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = symbols.map(s => `<div class="reel-item">${s}</div>`).join('');
        });

        // æ©Ÿå°è³‡æ–™
        let currentMachine = { totalSpins:12589, bbCount:156, rbCount:289, medalCount:20, bbPoint:8984002 };
        function updateDisplay() {
            document.getElementById('totalSpinsValue').innerText = currentMachine.totalSpins.toLocaleString();
            document.getElementById('bbCountValue').innerText = currentMachine.bbCount;
            document.getElementById('rbCountValue').innerText = currentMachine.rbCount;
            document.getElementById('medalNum').innerText = currentMachine.medalCount + 'Coin';
            document.getElementById('bbPoint').innerText = currentMachine.bbPoint.toLocaleString() + 'pt';
            const drawerMedal = document.getElementById('drawerMedal');
            if(drawerMedal) drawerMedal.innerText = currentMachine.medalCount;
        }
        updateDisplay();

        // ç°¡æ˜“åœ–è¡¨
        function renderChart() {
            const bars = document.getElementById('blockChartBars');
            if (!bars) return;
            const data = [4,3,5,2,4,3,4,3,2,3];
            bars.innerHTML = '';
            for (let i=0; i<10; i++) {
                const bar = document.createElement('div'); bar.className = 'blockChartBar';
                for (let b=0; b<data[i]; b++) {
                    const block = document.createElement('div');
                    block.className = `blockChartBlock ${b%2===0?'block-red':'block-green'}`;
                    bar.appendChild(block);
                }
                const val = document.createElement('div'); val.className = 'blockChartValue'; val.innerText = (20 + i*7).toString();
                bar.appendChild(val);
                bars.appendChild(bar);
            }
        }
        renderChart();
        document.querySelectorAll('.dataTab').forEach(tab => tab.addEventListener('click', function() {
            document.querySelectorAll('.dataTab').forEach(t=>t.classList.remove('active'));
            this.classList.add('active');
            renderChart();
        }));

        // æ»¾è¼ªæ§åˆ¶
        const reels = ['reelContentL','reelContentC','reelContentR'].map(id=>document.getElementById(id));
        const stops = ['btnStopL','btnStopC','btnStopR'].map(id=>document.getElementById(id));
        let rolling = false;
        stops.forEach(b=> b.disabled = true);

        document.getElementById('lever').addEventListener('click', ()=>{
            if (currentMachine.medalCount <= 0) { showMessage('ä»£å¹£ä¸è¶³','error'); return; }
            currentMachine.medalCount--;
            currentMachine.totalSpins++;
            updateDisplay();
            reels.forEach(r=> { 
                r.classList.add('reel-rolling'); 
                r.style.top = ''; 
            });
            rolling = true;
            stops.forEach(b=> b.disabled = false);
            showMessage('æ»¾è¼ªè½‰å‹•ä¸­');
        });

        stops.forEach((btn,i)=> btn.addEventListener('click', ()=>{
            if (!rolling) return;
            reels[i].classList.remove('reel-rolling');
            reels[i].style.top = `-${(Math.floor(Math.random()*7))*14.2857}%`;
            if (!reels.some(r=> r.classList.contains('reel-rolling'))) {
                rolling = false;
                stops.forEach(b=> b.disabled = true);
                if (Math.random()>0.6) showMessage('ä¸­ç!','success');
            }
        }));

        document.getElementById('purchaseMedal').addEventListener('click', ()=>{
            if (currentMachine.bbPoint>=50) {
                currentMachine.bbPoint -= 50;
                currentMachine.medalCount += 50;
                updateDisplay();
                showMessage('è³¼è²·50ä»£å¹£','success');
            } else showMessage('BBé»ä¸è¶³','error');
        });

        // å¤§è³ç‡ˆå°èˆª
        const pages = document.getElementById('prizeLightPages');
        const dots = document.querySelectorAll('.cyber-dot');
        const prev = document.getElementById('prevPrizeLightPage');
        const next = document.getElementById('nextPrizeLightPage');
        let curPage = 0;
        function setPage(p) {
            if (p<0||p>2) return;
            curPage = p;
            pages.style.transform = `translateX(-${p*33.333}%)`;
            dots.forEach((d,i)=> d.classList.toggle('active', i===p));
            showNav();
        }
        prev.addEventListener('click', ()=> setPage(curPage-1));
        next.addEventListener('click', ()=> setPage(curPage+1));
        dots.forEach(d=> d.addEventListener('click', function(){ setPage(parseInt(this.dataset.index)); }));

        const nav = document.getElementById('prizeLightNavigation');
        const zone = document.getElementById('prizeLightTouchZone');
        let hideTimer;
        function showNav() { nav.classList.add('active'); clearTimeout(hideTimer); hideTimer = setTimeout(()=> nav.classList.remove('active'), 4000); }
        zone.addEventListener('mouseenter', showNav);
        zone.addEventListener('touchstart', showNav);
        nav.addEventListener('mouseenter', ()=> clearTimeout(hideTimer));
        nav.addEventListener('mouseleave', ()=> hideTimer = setTimeout(()=> nav.classList.remove('active'), 1000));

        // å…¶ä»–æŒ‰éˆ•
        document.getElementById('btnReserve').addEventListener('click', ()=> showMessage('ä¿ç•™åŠŸèƒ½'));
        document.getElementById('maxBet').addEventListener('click', ()=> showMessage('MAX BET'));
        document.getElementById('btnHome').addEventListener('click', ()=> showMessage('é¦–é '));
        document.getElementById('btnBreak').addEventListener('click', ()=> showMessage('é›¢é–‹'));

        document.getElementById('machineHistoryList').innerHTML = '<div style="color:#c0ddec;">Â· 02/15 æœ€å¤§ç8500</div><div style="color:#c0ddec;">Â· 02/12 BBé€£ç™¼2æ¬¡</div>';
        document.getElementById('machineStrategyList').innerHTML = '<div style="color:#c0ddec;">ğŸ“Œ 20:00å¾ŒRBæ©Ÿç‡è¼ƒé«˜</div><div style="color:#c0ddec;">ğŸ“Œ é€£10æ²’ä¸­å¯ç•¥å¢æ³¨</div>';

        // æŠ½å±œ
        const triggerArea = document.getElementById('drawerTriggerArea');
        const drawer = document.getElementById('slideDrawer');
        const closeBtn = document.getElementById('drawerCloseBtn');
        triggerArea.addEventListener('click', (e) => { e.stopPropagation(); drawer.classList.toggle('open'); });
        closeBtn.addEventListener('click', (e) => { e.stopPropagation(); drawer.classList.remove('open'); });
        document.addEventListener('click', (e) => { if (!drawer.contains(e.target) && !triggerArea.contains(e.target)) drawer.classList.remove('open'); });
        document.getElementById('drawerSetting').addEventListener('click', (e) => { e.stopPropagation(); showMessage('å¿«æ·è¨­å®š'); });
        document.getElementById('drawerHistory').addEventListener('click', (e) => { e.stopPropagation(); showMessage('å¿«æ·ç´€éŒ„'); });

        // ========== ä¿®æ­£å¾Œçš„å­æ¯ç•«é¢ ==========
        let autoModeActive = false;
        let pipWindow = null;
        const autoBtn = document.getElementById('btnAuto');
        const isDocumentPiPSupported = 'documentPictureInPicture' in window;
        
        // æª¢æŸ¥æ˜¯å¦æ”¯æ´ PiP
        console.log('PiP æ”¯æ´åº¦:', isDocumentPiPSupported);

        autoBtn.addEventListener('click', async () => {
            autoModeActive = !autoModeActive;
            
            if (autoModeActive) {
                showMessage('è‡ªå‹•æ¨¡å¼é–‹å•Ÿï¼Œé»æ“Šã€ŒPiPæŒ‰éˆ•ã€å•Ÿå‹•å­æ¯ç•«é¢');
                
                // å¦‚æœæ”¯æ´ï¼Œç«‹å³é¡¯ç¤ºæç¤º
                if (isDocumentPiPSupported) {
                    // å¯ä»¥é¸æ“‡ç«‹å³é–‹å•Ÿ PiP
                    if (confirm('æ˜¯å¦ç«‹å³é–‹å•Ÿå­æ¯ç•«é¢ï¼Ÿ')) {
                        await enterPiP();
                    }
                } else {
                    showMessage('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å­æ¯ç•«é¢', 'error');
                }
            } else {
                if (pipWindow) {
                    pipWindow.close();
                    pipWindow = null;
                }
                showMessage('è‡ªå‹•æ¨¡å¼é—œé–‰');
            }
        });

        // æ‰‹å‹•è§¸ç™¼ PiP çš„å‡½æ•¸
        async function enterPiP() {
            if (!isDocumentPiPSupported) {
                showMessage('ç€è¦½å™¨ä¸æ”¯æ´å­æ¯ç•«é¢', 'error');
                return;
            }
            
            if (pipWindow) {
                pipWindow.focus();
                return;
            }

            try {
                showMessage('æ­£åœ¨é–‹å•Ÿå­æ¯ç•«é¢...');
                
                // è«‹æ±‚å­æ¯ç•«é¢è¦–çª—
                pipWindow = await window.documentPictureInPicture.requestWindow({
                    width: 360,
                    height: 640
                });

                // å»ºç«‹ PiP å…§å®¹
                const pipDoc = pipWindow.document;
                
                // æ·»åŠ æ¨£å¼
                const style = pipDoc.createElement('style');
                style.textContent = `
                    body { 
                        margin: 0; 
                        background: #10131c; 
                        display: flex; 
                        flex-direction: column; 
                        align-items: center; 
                        justify-content: center; 
                        height: 100vh; 
                        padding: 8px; 
                        font-family: sans-serif; 
                    }
                    .reel-container { 
                        display: flex; 
                        gap: 4px; 
                        background: #0d121b; 
                        border-radius: 20px; 
                        border: 1px solid #2f4457; 
                        padding: 4px; 
                        width: 100%; 
                        max-width: 340px; 
                    }
                    .reel { 
                        flex: 1; 
                        background: #1b2633; 
                        border-radius: 12px; 
                        border: 1px solid #3d5c70; 
                        overflow: hidden; 
                        position: relative; 
                        height: 140px; 
                    }
                    .reel-content { 
                        position: absolute; 
                        width: 100%; 
                        height: 700%; 
                        transition: top 0.12s linear;
                    }
                    .reel-item { 
                        height: 14.2857%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 26px; 
                        color: #c0e2f0; 
                        border-bottom: 1px solid #2e4e62; 
                        background: #1b2735; 
                    }
                    .reel-rolling { 
                        animation: roll 0.07s linear infinite; 
                    }
                    @keyframes roll { 
                        0% { transform: translateY(0); } 
                        100% { transform: translateY(-14.2857%); } 
                    }
                    .pip-status { 
                        color: #a0c8dd; 
                        margin-top: 12px; 
                        font-size: 15px; 
                        font-weight: bold; 
                        background: #1f2a36; 
                        padding: 6px 16px; 
                        border-radius: 40px; 
                        border: 1px solid #3487a7; 
                    }
                    .pip-button {
                        background: #2c4053;
                        color: white;
                        border: 1px solid #4e7a94;
                        border-radius: 40px;
                        padding: 8px 16px;
                        margin-top: 8px;
                        font-weight: bold;
                        box-shadow: 0 4px 0 #0a1a22;
                        cursor: pointer;
                    }
                    .pip-button:active {
                        transform: translateY(2px);
                        box-shadow: 0 2px 0 #0a1a22;
                    }
                `;
                pipDoc.head.appendChild(style);

                // å»ºç«‹å…§å®¹
                const body = pipDoc.body;

                // è¤‡è£½æ»¾è¼ªç‹€æ…‹
                const reelContainer = pipDoc.createElement('div');
                reelContainer.className = 'reel-container';
                
                // ç‚ºæ¯å€‹æ»¾è¼ªå»ºç«‹å…§å®¹
                for (let i = 0; i < 3; i++) {
                    const reel = pipDoc.createElement('div');
                    reel.className = 'reel';
                    
                    const reelContent = pipDoc.createElement('div');
                    reelContent.className = `reel-content ${rolling ? 'reel-rolling' : ''}`;
                    
                    // å¦‚æœå·²ç¶“åœæ­¢ï¼Œè¨­å®šä½ç½®
                    if (!rolling && reels[i] && reels[i].style.top) {
                        reelContent.style.top = reels[i].style.top;
                    }
                    
                    // åŠ å…¥ç¬¦è™Ÿ
                    symbols.forEach(s => {
                        const item = pipDoc.createElement('div');
                        item.className = 'reel-item';
                        item.textContent = s;
                        reelContent.appendChild(item);
                    });
                    
                    reel.appendChild(reelContent);
                    reelContainer.appendChild(reel);
                }
                
                body.appendChild(reelContainer);

                // ç‹€æ…‹æ–‡å­—
                const statusDiv = pipDoc.createElement('div');
                statusDiv.className = 'pip-status';
                statusDiv.textContent = autoModeActive ? 'âš¡ è‡ªå‹•æ¨¡å¼é‹è½‰ä¸­' : 'ğŸ° å­æ¯ç•«é¢';
                body.appendChild(statusDiv);

                // è¿”å›ä¸»è¦–çª—æŒ‰éˆ•
                const backButton = pipDoc.createElement('button');
                backButton.className = 'pip-button';
                backButton.textContent = 'è¿”å›ä¸»ç•«é¢';
                backButton.onclick = () => {
                    window.focus();
                };
                body.appendChild(backButton);

                // ç›£è½é—œé–‰äº‹ä»¶
                pipWindow.addEventListener('pagehide', () => {
                    pipWindow = null;
                });

                // åŒæ­¥æ»¾è¼ªç‹€æ…‹
                const syncInterval = setInterval(() => {
                    if (!pipWindow) {
                        clearInterval(syncInterval);
                        return;
                    }
                    
                    // åŒæ­¥æ»¾è¼ªå‹•ç•«ç‹€æ…‹
                    const pipReels = pipDoc.querySelectorAll('.reel-content');
                    if (pipReels.length === 3) {
                        pipReels.forEach((pipReel, index) => {
                            if (rolling) {
                                pipReel.classList.add('reel-rolling');
                            } else {
                                pipReel.classList.remove('reel-rolling');
                                if (reels[index] && reels[index].style.top) {
                                    pipReel.style.top = reels[index].style.top;
                                }
                            }
                        });
                    }
                }, 100);

                showMessage('å­æ¯ç•«é¢å•Ÿå‹•æˆåŠŸ', 'success');

            } catch (err) {
                console.error('PiP éŒ¯èª¤:', err);
                showMessage('å­æ¯ç•«é¢é–‹å•Ÿå¤±æ•—: ' + err.message, 'error');
                pipWindow = null;
            }
        }

        // ç›£è½é é¢éš±è—
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && autoModeActive && isDocumentPiPSupported && !pipWindow) {
                enterPiP();
            }
        });

        // æ·»åŠ ä¸€å€‹æ¸¬è©¦æŒ‰éˆ•ä¾†æ‰‹å‹•è§¸ç™¼ PiP (å¯ä»¥åŠ åˆ° drawer ä¸­)
        // å‹•æ…‹æ·»åŠ æ¸¬è©¦æŒ‰éˆ•åˆ°æŠ½å±œ
        const drawerFooter = document.querySelector('.drawer-footer');
        if (drawerFooter) {
            const pipTestBtn = document.createElement('button');
            pipTestBtn.id = 'pipTestBtn';
            pipTestBtn.textContent = 'ğŸ“º PiP';
            pipTestBtn.style.background = '#2c4053';
            pipTestBtn.style.color = 'white';
            pipTestBtn.style.border = '1px solid #4e7a94';
            pipTestBtn.style.borderRadius = '30px';
            pipTestBtn.style.padding = '5px 0';
            pipTestBtn.style.fontSize = '9px';
            pipTestBtn.style.fontWeight = 'bold';
            pipTestBtn.style.boxShadow = '0 3px 0 #0f303f';
            pipTestBtn.style.cursor = 'pointer';
            
            pipTestBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                enterPiP();
            });
            
            drawerFooter.appendChild(pipTestBtn);
        }

        // å­—é«”é©æ‡‰
        function adjustUIFontSize() { /* ç„¡éœ€é¡å¤–å‹•ä½œï¼Œä½¿ç”¨clampå³å¯ */ }
        adjustUIFontSize();
        window.addEventListener('resize', adjustUIFontSize);
    })();
</script>
